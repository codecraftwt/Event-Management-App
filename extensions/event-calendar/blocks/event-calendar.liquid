{% schema %}
{
  "name": "Event Calendar",
  "target": "section",
  "settings": []
}
{% endschema %}

<div class="event-header">
  <h2 class="event-heading">Events</h2>
  <div class="event-view-buttons">
    <button id="gridViewBtn">Grid</button>
    <button id="listViewBtn">List</button>
    <button id="calendarViewBtn">Calendar</button>
  </div>
</div>

<div id="event-calendar">
  <p>Loading events...</p>
</div>

<!-- Booking Modal -->
<div id="bookingModal" class="modal">
  <div class="modal-content modal-two-column">
    <span id="closeModal">&times;</span>

    <!-- Left Column: Image Card -->
    <div class="modal-left">
      <div class="image-card">
        <img id="modalImage" src="" alt="Event Image">
      </div>
    </div>

    <!-- Right Column: Event Info -->
    <div class="modal-right">
      <div class="info-card">
        <h3 id="modalTitle">Event Title</h3>
        <p id="modalDate"></p>
        <p id="modalDesc"></p>

        <form id="bookingForm">
          <input type="hidden" id="eventId" name="eventId">
          <label>Name</label>
          <input type="text" id="name" required>
          <label>Email</label>
          <input type="email" id="email" required>
          <label>Tickets</label>
          <input type="number" id="tickets" min="1" value="1" required>
          <div class="modal-buttons">
            <button type="button" id="addToCartBtn">Add to Cart</button>
            <button type="submit">Book Now</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f1f3f6;
    margin: 0;
    padding: 0;
  }
  /* Force event-calendar container to full width */
  #event-calendar {
    width: 100%;
    padding: 20px 0;
    box-sizing: border-box;
  }
  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 10px 20px;
  }
  .event-heading {
    font-size: 24px;
    font-weight: 600;
    color: #333;
  }
  .event-view-buttons button {
    margin-left: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    background: #f1f3f6;
    color: #333;
    box-shadow: 5px 5px 10px #d1d9e6,
                -5px -5px 10px #ffffff;
    transition: all 0.2s ease-in-out;
  }
  .event-view-buttons button:hover {
    box-shadow: inset 3px 3px 6px #d1d9e6,
                inset -3px -3px 6px #ffffff;
  }

  /* Grid */
  .grid-container {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    padding: 0 20px;
  }
  .grid-item {
    flex: 1 1 calc(33% - 20px);
    background: #f1f3f6;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    box-shadow: 5px 5px 15px #d1d9e6,
                -5px -5px 15px #ffffff;
    transition: transform 0.2s ease;
    cursor: pointer;
  }
  .grid-item:hover { transform: translateY(-5px); }
  .grid-item img {
    display: block;              /* make img a block element */
    margin: 0 auto 10px auto;    /* auto left/right margins center it */
    width: 100%;
    max-width: 220px;
    border-radius: 12px;
    box-shadow: 3px 3px 8px #d1d9e6,
              -3px -3px 8px #ffffff;
  }
  .grid-item strong { display: block; font-size: 18px; margin-bottom: 6px; color: #333; }
  .grid-item span { display: block; font-size: 14px; color: #666; margin: 2px 0; }

  /* List */
  .list-container {
    width: 95vw;
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 0 20px;
  }
  .list-item {
    display: flex;
    align-items: center;
    background: #f1f3f6;
    border-radius: 12px;
    padding: 10px 15px;
    width: 100%;
    height: 120px;
    box-shadow: 4px 4px 10px #d1d9e6,
                -4px -4px 10px #ffffff;
    transition: transform 0.2s ease;
    box-sizing: border-box;
    cursor: pointer;
  }
  .list-item:hover { transform: translateX(5px); }
  .list-item img {
    border-radius: 10px;
    margin-right: 15px;
    width: 50px;
    height: 50px;
    object-fit: contain;
    box-shadow: 2px 2px 6px #d1d9e6,
                -2px -2px 6px #ffffff;
  }
  .list-item .info {
    font-size: 14px;
    color: #444;
    flex: 1;
  }

  /* FullCalendar container */
  #calendar {
    max-width: 100%;
    margin: 0 auto;
    background: #f1f3f6;
    border-radius: 16px;
    box-shadow: 5px 5px 15px #d1d9e6,
                -5px -5px 15px #ffffff;
    padding: 10px;
  }

 /* Modal Overlay */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  overflow-y: auto;
}

/* Modal Container */
.modal-content.modal-two-column {
  position: relative;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%); /* always center */
  display: flex;
  flex-direction: row;
  max-width: 900px;
  width: 90%;
  background: #e0e5ec;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 10px 10px 20px #c1c6d0, -10px -10px 20px #ffffff;
  gap: 20px;
}

/* Close button */
#closeModal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 24px;
  cursor: pointer;
  color: #333;
}

/* Left Column */
.modal-left {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-card {
  background: #e0e5ec;
  padding: 15px;
  border-radius: 20px;
  box-shadow: 6px 6px 12px #c1c6d0, -6px -6px 12px #ffffff;
  width: 100%;
  max-width: 350px;
}

.image-card img {
  width: 100%;
  height: auto;
  border-radius: 16px;
  display: block;
  object-fit: cover;
}

/* Right Column */
.modal-right {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.info-card {
  background: #e0e5ec;
  padding: 20px;
  border-radius: 20px;
  box-shadow: 6px 6px 12px #c1c6d0, -6px -6px 12px #ffffff;
  width: 100%;
  max-width: 400px;
  overflow-y: auto;
}

.info-card h3 {
  margin-top: 0;
  font-size: 24px;
  color: #333;
}

.info-card p {
  margin: 10px 0;
  color: #555;
}

.info-card label {
  display: block;
  margin: 10px 0 5px;
  color: #333;
}

.info-card input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 12px;
  border: none;
  box-shadow: inset 4px 4px 8px #c1c6d0, inset -4px -4px 8px #ffffff;
  background: #e0e5ec;
  color: #333;
  font-size: 14px;
  box-sizing: border-box;
}

.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.modal-buttons button {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  box-shadow: 6px 6px 12px #c1c6d0, -6px -6px 12px #ffffff;
  transition: all 0.2s ease-in-out;
}

#addToCartBtn {
  background: #e0e5ec;
  color: #333;
}

#addToCartBtn:hover {
  box-shadow: inset 4px 4px 8px #c1c6d0, inset -4px -4px 8px #ffffff;
}

#bookingForm button[type="submit"] {
  background: #333;
  color: #fff;
}

#bookingForm button[type="submit"]:hover {
  background: #555;
}

/* Responsive */
@media(max-width: 768px) {
  .modal-content.modal-two-column {
    flex-direction: column;
  }

  .modal-left, .modal-right {
    max-width: 100%;
  }

  .image-card, .info-card {
    max-width: 100%;
  }
}
</style>

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
(async () => {
  const container = document.getElementById('event-calendar');
  let events = [];

  try {
    const response = await fetch("https://frost-martha-amazing-friendly.trycloudflare.com/api/events");
    events = await response.json();

    if (!events || events.length === 0) {
      container.innerHTML = "<p>No events found.</p>";
      return;
    }

    showGrid(events); // default

    document.getElementById("gridViewBtn").addEventListener("click", () => showGrid(events));
    document.getElementById("listViewBtn").addEventListener("click", () => showList(events));
    document.getElementById("calendarViewBtn").addEventListener("click", () => showCalendar(events));
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p>Failed to load events.</p>";
  }

  function showGrid(events) {
    let html = `<div class="grid-container">`;
    events.forEach(event => {
      html += `
        <div class="grid-item" onclick="openBookingModal(${event.id}, '${event.title}', '${event.date}', '${event.time}', '${event.description}', '${event.image}')">
          <img src="${event.image}" alt="${event.title}">
          <strong>${event.title}</strong>
          <span>${event.place} • ${event.tag}</span>
          <span>${new Date(event.date).toLocaleDateString()} ${event.time}</span>
        </div>`;
    });
    html += "</div>";
    container.innerHTML = html;
  }

  function showList(events) {
    let html = `<div class="list-container">`;
    events.forEach(event => {
      html += `
        <div class="list-item" onclick="openBookingModal(${event.id}, '${event.title}', '${event.date}', '${event.time}', '${event.description}', '${event.image}')">
          <img src="${event.image}" alt="${event.title}">
          <div class="info">
            <strong>${event.title}</strong> <br/>
            ${event.place} • ${event.tag}<br/>
            ${new Date(event.date).toLocaleDateString()} <br/>
            ${event.time}
          </div>
        </div>`;
    });
    html += "</div>";
    container.innerHTML = html;
  }

  function showCalendar(events) {
    container.innerHTML = `<div id="calendar"></div>`;
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      height: 'auto',
      events: events.map(e => ({
        id: e.id,
        title: e.title,
        start: e.date,
        extendedProps: { time: e.time },
        description : e.description,
        image : e.image
      })),
      eventClick: function(info) {
        info.jsEvent.preventDefault();
        openBookingModal(info.event.id, info.event.title, info.event.start, info.event.extendedProps.time, info.event.extendedProps.description, info.event.extendedProps.image);
      },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      }
    });
    calendar.render();
  }
})();

// Modal logic
window.openBookingModal = function(id, title, date, time, description, image) {
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalDate").innerText = new Date(date).toLocaleDateString() + " " + (time || "");
  document.getElementById("modalDesc").innerText = description;
  document.getElementById("eventId").value = id;

  const modalImage = document.getElementById("modalImage");
  if (image) {
    modalImage.src = image;
    modalImage.style.display = "block";
  } else {
    modalImage.style.display = "none"; // hide if no image
  }

  document.getElementById("bookingModal").style.display = "block";
}

document.getElementById("closeModal").onclick = () => {
  document.getElementById("bookingModal").style.display = "none";
};

window.onclick = function(event) {
  if (event.target == document.getElementById("bookingModal")) {
    document.getElementById("bookingModal").style.display = "none";
  }
};

document.getElementById("bookingForm").onsubmit = async function(e) {
  e.preventDefault();

  const formData = new FormData();
  formData.append("eventId", document.getElementById("eventId").value);
  formData.append("name", document.getElementById("name").value);
  formData.append("email", document.getElementById("email").value);
  formData.append("tickets", document.getElementById("tickets").value);

  try {
    const response = await fetch("https://frost-martha-amazing-friendly.trycloudflare.com/api/bookings", {
      method: "POST",
      body: formData
    });

    const result = await response.json();
    if (result.success) {
      alert("Booking successful!");
      document.getElementById("bookingModal").style.display = "none";
    } else {
      alert("Booking failed: " + result.message);
    }
  } catch (err) {
    console.error(err);
    alert("Booking failed: " + err.message);
  }
};


</script>
